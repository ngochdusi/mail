function deleteUsersAndRemoveRows() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Sheet1');
  const data = sheet.getDataRange().getValues();
  const MAX_DELETE = 200;

  let deletedCount = 0;

  // Duyá»‡t NGÆ¯á»¢C Ä‘á»ƒ xÃ³a khÃ´ng bá»‹ lá»‡ch chá»‰ sá»‘
  for (let i = data.length - 1; i >= 1; i--) {
    const row = data[i];
    let emailFound = null;

    // ğŸ” TÃ¬m email trong dÃ²ng
    for (let cell of row) {
      if (typeof cell === 'string' && cell.includes('@')) {
        emailFound = cell.trim();
        break;
      }
    }

    if (!emailFound) continue;

    try {
      const user = AdminDirectory.Users.get(emailFound);

      if (user.isAdmin || user.isDelegatedAdmin) {
        Logger.log('ğŸš« Bá» qua admin: ' + emailFound);
        sheet.getRange(i + 1, row.length + 1).setValue("Bá» qua: LÃ  Admin");
        continue;
      }

      AdminDirectory.Users.remove(emailFound);
      Logger.log('âœ… ÄÃ£ xÃ³a user: ' + emailFound);

      sheet.deleteRow(i + 1); // ğŸ§¹ XÃ³a ngay dÃ²ng vá»«a xá»­ lÃ½
      deletedCount++;
      Utilities.sleep(200); // delay nhá» trÃ¡nh quota lá»—i

    } catch (err) {
      const errorMsg = err.message || '';
      Logger.log(`âš ï¸ Lá»—i khi xá»­ lÃ½ ${emailFound}: ${errorMsg}`);

      // âœ… CÃ¡c lá»—i váº«n xÃ³a dÃ²ng
      if (
        errorMsg.includes("Resource Not Found") ||
        errorMsg.includes("Not Authorized to access this resource") ||
        errorMsg.includes("Not Authorized to access this resource/api") ||
        errorMsg.includes("notAuthorized") ||
        errorMsg.includes("User not found") ||
        errorMsg.includes("Invalid Input")
      ) {
        Logger.log("ğŸ—‘ï¸ DÃ²ng bá»‹ xÃ³a do lá»—i truy cáº­p hoáº·c user khÃ´ng tá»“n táº¡i: " + emailFound);
        sheet.deleteRow(i + 1); // â— XÃ³a ngay khi lá»—i loáº¡i nÃ y
      } else {
        // âŒ Lá»—i khÃ¡c â†’ ghi láº¡i trÃªn sheet
        sheet.getRange(i + 1, row.length + 1).setValue("Lá»—i: " + errorMsg);
      }
    }

    if (deletedCount >= MAX_DELETE) {
      Logger.log("âš ï¸ Äáº¡t giá»›i háº¡n xÃ³a " + MAX_DELETE + " user, dá»«ng láº¡i.");
      break;
    }
  }

  Logger.log("ğŸ¯ HoÃ n táº¥t. Tá»•ng sá»‘ dÃ²ng Ä‘Ã£ xÃ³a: " + deletedCount);
  Browser.msgBox("ÄÃ£ xÃ³a " + deletedCount + " dÃ²ng khá»i Sheet1.");
}
