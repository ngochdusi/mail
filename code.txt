function deleteUsersAndRemoveRows() { 
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Sheet1');
  const data = sheet.getDataRange().getValues();
  const MAX_DELETE = 200;

  let rowsToDelete = [];
  let deletedCount = 0;

  for (let i = 1; i < data.length; i++) {
    let row = data[i];
    let emailFound = null;

    for (let cell of row) {
      if (typeof cell === 'string' && cell.includes('@')) {
        emailFound = cell.trim();
        break;
      }
    }

    if (!emailFound) continue;

    try {
      const user = AdminDirectory.Users.get(emailFound);

      if (user.isAdmin || user.isDelegatedAdmin) {
        Logger.log('Bỏ qua admin: ' + emailFound);
        sheet.getRange(i + 1, row.length + 1).setValue("Bỏ qua: Là Admin");
        continue;
      }

      AdminDirectory.Users.remove(emailFound);
      Logger.log('Đã xóa user: ' + emailFound);
      rowsToDelete.push(i + 1);
      deletedCount++;

    } catch (err) {
      const errorMsg = err.message || '';
      Logger.log(`Lỗi khi xử lý ${emailFound}: ${errorMsg}`);

      if (errorMsg.includes("Resource Not Found")) {
        // Nếu không tìm thấy user thì cũng xóa dòng
        rowsToDelete.push(i + 1);
        Logger.log("Dòng này sẽ bị xóa vì user không tồn tại: " + emailFound);
      } else {
        // Ghi lỗi nếu là lỗi khác
        sheet.getRange(i + 1, row.length + 1).setValue("Lỗi: " + errorMsg);
      }
    }

    if (deletedCount >= MAX_DELETE) break;
  }

  // Xóa từ dưới lên
  rowsToDelete.sort((a, b) => b - a).forEach(row => {
    sheet.deleteRow(row);
  });
}
